var U=Object.defineProperty;var b=(s,e,t)=>e in s?U(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var r=(s,e,t)=>(b(s,typeof e!="symbol"?e+"":e,t),t);import{j as N}from"./jsx-runtime-2aae9559.js";import{r as M}from"./index-ff614419.js";import{a6 as H,a7 as $,l as j}from"./SPA-b6af1813.js";import"./index-072c1eb7.js";const B=s=>M.createElement(H.Provider,{value:s.theme},s.children);var w=(s=>(s.READY="ready.app.deskpro",s.SHOW="show.app.deskpro",s.CHANGE="change.app.deskpro",s.TARGET_ACTION="target_action.app.deskpro",s.TARGET_ELEMENT_EVENT="target_element_event.app.deskpro",s.ADMIN_SETTINGS_CHANGE="change.settings.admin.app.deskpro",s))(w||{}),A;(function(s){s.Call="call",s.Reply="reply",s.Syn="syn",s.SynAck="synAck",s.Ack="ack"})(A||(A={}));var C;(function(s){s.Fulfilled="fulfilled",s.Rejected="rejected"})(C||(C={}));var k;(function(s){s.ConnectionDestroyed="ConnectionDestroyed",s.ConnectionTimeout="ConnectionTimeout",s.NoIframeSrc="NoIframeSrc"})(k||(k={}));var G;(function(s){s.DataCloneError="DataCloneError"})(G||(G={}));var _;(function(s){s.Message="message"})(_||(_={}));const V=(s,e)=>{const t=[];let n=!1;return{destroy(i){n||(n=!0,e(`${s}: Destroying connection`),t.forEach(o=>{o(i)}))},onDestroy(i){n?i():t.push(i)}}},J=s=>(...e)=>{s&&console.log("[Penpal]",...e)},x=({name:s,message:e,stack:t})=>({name:s,message:e,stack:t}),K=s=>{const e=new Error;return Object.keys(s).forEach(t=>e[t]=s[t]),e},W=(s,e,t)=>{const{localName:n,local:i,remote:o,originForSending:c,originForReceiving:h}=s;let g=!1;const u=a=>{if(a.source!==o||a.data.penpal!==A.Call)return;if(h!=="*"&&a.origin!==h){t(`${n} received message from origin ${a.origin} which did not match expected origin ${h}`);return}const l=a.data,{methodName:f,args:d,id:p}=l;t(`${n}: Received ${f}() call`);const E=y=>m=>{if(t(`${n}: Sending ${f}() reply`),g){t(`${n}: Unable to send ${f}() reply due to destroyed connection`);return}const S={penpal:A.Reply,id:p,resolution:y,returnValue:m};y===C.Rejected&&m instanceof Error&&(S.returnValue=x(m),S.returnValueIsError=!0);try{o.postMessage(S,c)}catch(v){if(v.name===G.DataCloneError){const P={penpal:A.Reply,id:p,resolution:C.Rejected,returnValue:x(v),returnValueIsError:!0};o.postMessage(P,c)}throw v}};new Promise(y=>y(e[f].apply(e,d))).then(E(C.Fulfilled),E(C.Rejected))};return i.addEventListener(_.Message,u),()=>{g=!0,i.removeEventListener(_.Message,u)}};let Y=0;const q=()=>++Y,R=".",L=s=>s?s.split(R):[],Q=s=>s.join(R),X=(s,e)=>{const t=L(e||"");return t.push(s),Q(t)},Z=(s,e,t)=>{const n=L(e);return n.reduce((i,o,c)=>(typeof i[o]>"u"&&(i[o]={}),c===n.length-1&&(i[o]=t),i[o]),s),s},z=(s,e)=>{const t={};return Object.keys(s).forEach(n=>{const i=s[n],o=X(n,e);typeof i=="object"&&Object.assign(t,z(i,o)),typeof i=="function"&&(t[o]=i)}),t},ee=s=>{const e={};for(const t in s)Z(e,t,s[t]);return e},te=(s,e,t,n,i)=>{const{localName:o,local:c,remote:h,originForSending:g,originForReceiving:u}=e;let a=!1;i(`${o}: Connecting call sender`);const l=d=>(...p)=>{i(`${o}: Sending ${d}() call`);let E;try{h.closed&&(E=!0)}catch{E=!0}if(E&&n(),a){const y=new Error(`Unable to send ${d}() call due to destroyed connection`);throw y.code=k.ConnectionDestroyed,y}return new Promise((y,m)=>{const S=q(),v=T=>{if(T.source!==h||T.data.penpal!==A.Reply||T.data.id!==S)return;if(u!=="*"&&T.origin!==u){i(`${o} received message from origin ${T.origin} which did not match expected origin ${u}`);return}const D=T.data;i(`${o}: Received ${d}() reply`),c.removeEventListener(_.Message,v);let O=D.returnValue;D.returnValueIsError&&(O=K(O)),(D.resolution===C.Fulfilled?y:m)(O)};c.addEventListener(_.Message,v);const P={penpal:A.Call,id:S,methodName:d,args:p};h.postMessage(P,g)})},f=t.reduce((d,p)=>(d[p]=l(p),d),{});return Object.assign(s,ee(f)),()=>{a=!0}},se=(s,e)=>{let t;return s!==void 0&&(t=window.setTimeout(()=>{const n=new Error(`Connection timed out after ${s}ms`);n.code=k.ConnectionTimeout,e(n)},s)),()=>{clearTimeout(t)}},ne=(s,e,t,n)=>{const{destroy:i,onDestroy:o}=t;return c=>{if(!(s instanceof RegExp?s.test(c.origin):s==="*"||s===c.origin)){n(`Child: Handshake - Received SYN-ACK from origin ${c.origin} which did not match expected origin ${s}`);return}n("Child: Handshake - Received SYN-ACK, responding with ACK");const g=c.origin==="null"?"*":c.origin,u={penpal:A.Ack,methodNames:Object.keys(e)};window.parent.postMessage(u,g);const a={localName:"Child",local:window,remote:window.parent,originForSending:g,originForReceiving:c.origin},l=W(a,e,n);o(l);const f={},d=te(f,a,c.data.methodNames,i,n);return o(d),f}},ie=()=>{try{clearTimeout()}catch{return!1}return!0},re=(s={})=>{const{parentOrigin:e="*",methods:t={},timeout:n,debug:i=!1}=s,o=J(i),c=V("Child",o),{destroy:h,onDestroy:g}=c,u=z(t),a=ne(e,u,c,o),l=()=>{o("Child: Handshake - Sending SYN");const d={penpal:A.Syn},p=e instanceof RegExp?"*":e;window.parent.postMessage(d,p)};return{promise:new Promise((d,p)=>{const E=se(n,h),y=m=>{if(ie()&&!(m.source!==parent||!m.data)&&m.data.penpal===A.SynAck){const S=a(m);S&&(window.removeEventListener(_.Message,y),E(),d(S))}};window.addEventListener(_.Message,y),l(),g(m=>{window.removeEventListener(_.Message,y),m&&p(m)})}),destroy(){h()}}};class I extends Error{}class oe{constructor(e){this.client=e}send(e){return this.client.sendDeskproUIMessage(e)}appendContentToActiveTicketReplyBox(e){return this.send({type:"append_to_active_ticket_reply_box",content:e})}appendLinkToActiveTicketReplyBox(e,t,n){return this.send({type:"append_link_to_active_ticket_reply_box",url:e,text:t,title:n})}alertSuccess(e,t){return this.send({type:"alert_success",text:e,duration:t})}alertError(e,t){return this.send({type:"alert_error",text:e,duration:t})}alertDismiss(){return this.send({type:"alert_dismiss"})}}class ae{constructor(e,t,n){this.client=e,this.name=t,this.entityId=n}async get(e){const t=await this.client.entityAssociationGet(this.entityId,this.name,e);return t?JSON.parse(t):null}list(){return this.client.entityAssociationList(this.entityId,this.name)}set(e,t){return this.client.entityAssociationSet(this.entityId,this.name,e,t?JSON.stringify(t):void 0)}delete(e){return this.client.entityAssociationDelete(this.entityId,this.name,e)}}class ce{constructor(e,t){r(this,"parentMethods",{onReady:()=>{},onShow:()=>{},onChange:()=>{},onTargetAction:()=>{},onElementEvent:()=>{},onAdminSettingsChange:()=>{}});r(this,"getProxyAuth");r(this,"getAdminGenericProxyAuth");r(this,"resize");r(this,"setHeight");r(this,"setWidth");r(this,"registerElement");r(this,"deregisterElement");r(this,"setBadgeCount");r(this,"setTitle");r(this,"focus");r(this,"unfocus");r(this,"openContact");r(this,"entityAssociationSet");r(this,"entityAssociationDelete");r(this,"entityAssociationGet");r(this,"entityAssociationList");r(this,"entityAssociationCountEntities");r(this,"setState");r(this,"setUserState");r(this,"getState");r(this,"getUserState");r(this,"deleteState");r(this,"deleteUserState");r(this,"hasState");r(this,"hasUserState");r(this,"setSetting");r(this,"setSettings");r(this,"setBlocking");r(this,"registerTargetAction");r(this,"deregisterTargetAction");r(this,"startOAuth2LocalFlow");r(this,"startOAuth2GlobalFlow");r(this,"pollOAuth2Flow");r(this,"setAdminSetting");r(this,"setAdminSettingInvalid");r(this,"sendDeskproUIMessage");this.parent=e,this.options=t,this.getProxyAuth=()=>new Promise(()=>{}),this.getAdminGenericProxyAuth=()=>new Promise(()=>{}),this.resize=()=>{},this.setWidth=()=>{},this.setHeight=()=>{},this.registerElement=()=>{},this.deregisterElement=()=>{},this.setBadgeCount=()=>{},this.setTitle=()=>{},this.focus=()=>{},this.unfocus=()=>{},this.openContact=()=>{},this.entityAssociationSet=async()=>{},this.entityAssociationDelete=async()=>{},this.entityAssociationGet=async()=>null,this.entityAssociationList=async()=>[""],this.entityAssociationCountEntities=async()=>0,this.setState=async()=>({isSuccess:!1,errors:[]}),this.setUserState=async()=>({isSuccess:!1,errors:[]}),this.getState=async()=>[],this.getUserState=async()=>[],this.deleteState=async()=>!1,this.deleteUserState=async()=>!1,this.hasState=async()=>!1,this.hasUserState=async()=>!1,this.setSetting=async()=>{},this.setSettings=async()=>{},this.setBlocking=async()=>{},this.registerTargetAction=async()=>{},this.deregisterTargetAction=async()=>{},this.startOAuth2LocalFlow=async()=>({}),this.startOAuth2GlobalFlow=async()=>({}),this.pollOAuth2Flow=async()=>({}),this.setAdminSetting=async()=>{},this.setAdminSettingInvalid=async()=>{},this.sendDeskproUIMessage=async()=>{},this.options.runAfterPageLoad&&window.addEventListener("load",()=>this.run())}async run(){const e=await this.parent({methods:{_onReady:this.parentMethods.onReady,_onShow:this.parentMethods.onShow,_onChange:this.parentMethods.onChange,_onTargetAction:this.parentMethods.onTargetAction,_onElementEvent:this.parentMethods.onElementEvent,_onAdminSettingsChange:this.parentMethods.onAdminSettingsChange}}).promise;e._getProxyAuth&&(this.getProxyAuth=e._getProxyAuth),e._getAdminGenericProxyAuth&&(this.getAdminGenericProxyAuth=e._getAdminGenericProxyAuth),document&&e._setHeight&&(this.resize=t=>e._setHeight(t??document.body.scrollHeight)),e._registerElement&&(this.registerElement=(t,n)=>e._registerElement(t,n)),e._deregisterElement&&(this.deregisterElement=t=>e._deregisterElement(t)),e._setWidth&&(this.setWidth=e._setWidth),e._setHeight&&(this.setHeight=e._setHeight),e.setBadgeCount&&(this.setBadgeCount=e.setBadgeCount),e.setTitle&&(this.setTitle=e.setTitle),e.focus&&(this.focus=e.focus),e.unfocus&&(this.unfocus=e.unfocus),e.openContact&&(this.openContact=e.openContact),e._entityAssociationGet&&(this.entityAssociationGet=e._entityAssociationGet),e._entityAssociationSet&&(this.entityAssociationSet=e._entityAssociationSet),e._entityAssociationList&&(this.entityAssociationList=e._entityAssociationList),e._entityAssociationDelete&&(this.entityAssociationDelete=e._entityAssociationDelete),e._entityAssociationCountEntities&&(this.entityAssociationCountEntities=e._entityAssociationCountEntities),e._stateSet&&(this.setState=(t,n,i)=>e._stateSet(t,JSON.stringify(n),i)),e._userStateSet&&(this.setUserState=(t,n,i)=>e._userStateSet(t,JSON.stringify(n),i)),e._stateGet&&(this.getState=async t=>(JSON.parse(await e._stateGet(t))??[]).map(i=>({...i,data:i.data?JSON.parse(i.data):null}))),e._userStateGet&&(this.getUserState=async t=>(JSON.parse(await e._userStateGet(t))??[]).map(i=>({...i,data:i.data?JSON.parse(i.data):null}))),e._stateDelete&&(this.deleteState=e._stateDelete),e._userStateDelete&&(this.deleteUserState=e._userStateDelete),e._stateHas&&(this.hasState=e._stateHas),e._userStateHas&&(this.hasUserState=e._userStateHas),e._settingSet&&(this.setSetting=(t,n)=>e._settingSet(t,n)),e._settingsSet&&(this.setSettings=t=>e._settingsSet(JSON.stringify(t))),e._blockingSet&&(this.setBlocking=t=>e._blockingSet(t)),e._registerTargetAction&&(this.registerTargetAction=(t,n,i)=>e._registerTargetAction(t,n,i)),e._deregisterTargetAction&&(this.deregisterTargetAction=t=>e._deregisterTargetAction(t)),e._startOAuth2LocalFlow&&(this.startOAuth2LocalFlow=(t,n)=>e._startOAuth2LocalFlow(t.source,n)),e._startOAuth2GlobalFlow&&(this.startOAuth2GlobalFlow=(t,n)=>e._startOAuth2GlobalFlow(t,n)),e._pollOAuth2Flow&&(this.pollOAuth2Flow=t=>e._pollOAuth2Flow(t)),e._setAdminSetting&&(this.setAdminSetting=t=>e._setAdminSetting(t)),e._setAdminSettingInvalid&&(this.setAdminSettingInvalid=(t,n)=>e._setAdminSettingInvalid(t,n)),e._sendDeskproUIMessage&&(this.sendDeskproUIMessage=t=>e._sendDeskproUIMessage(t))}onReady(e){this.parentMethods.onReady=t=>{e(t),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onShow(e){this.parentMethods.onShow=t=>{e(t),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onChange(e){this.parentMethods.onChange=t=>{e(t),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onTargetAction(e){this.parentMethods.onTargetAction=t=>{e(t),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onElementEvent(e){this.parentMethods.onElementEvent=(t,n,i)=>{e(t,n,i),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onAdminSettingsChange(e){this.parentMethods.onAdminSettingsChange=t=>{e(t)}}getEntityAssociation(e,t){return new ae(this,e,t)}async startOauth2Local(e,t,n,i){const o=(i==null?void 0:i.timeout)??6e5,c=(i==null?void 0:i.pollInterval)??2e3,h=await this.startOAuth2LocalFlow(t,o),g=e({state:h.state,callbackUrl:h.callbackUrl,codeChallenge:h.codeChallenge});return{poll:()=>new Promise((a,l)=>{const f=setInterval(()=>{this.pollOAuth2Flow(h.state).then(d=>{if(d&&d.status!=="Pending"){if(clearInterval(f),d.error){l(new I(d.error));return}n(d.authCode,d.codeVerifierProxyPlaceholder).then(a)}})},c);setTimeout(()=>{clearInterval(f),l(new I("Acquisition timeout"))},o)}),authorizationUrl:g}}async startOauth2Global(e,t){const n=(t==null?void 0:t.timeout)??6e5,i=(t==null?void 0:t.pollInterval)??2e3,o=await this.startOAuth2GlobalFlow(e,n);return{poll:()=>new Promise((h,g)=>{const u=setInterval(()=>{this.pollOAuth2Flow(o.state).then(a=>{if(a&&a.status!=="Pending"){if(clearInterval(u),a.error){g(new I(a.error));return}h({data:a})}})},i);setTimeout(()=>{clearInterval(u),g(new I("Acquisition timeout"))},n)}),authorizationUrl:o.authorizationUrl}}deskpro(){return new oe(this)}getParentMethods(){return this.parentMethods}}const le=(s={})=>new ce(re,s),de=M.createContext(null),F=({children:s,theme:e,debug:t})=>{const[n,i]=M.useState(null),[o,c]=M.useState(null),[h,g]=M.useState([]);M.useEffect(()=>{if(n)return;const a=le({runAfterPageLoad:!1,resizeAfterEvents:!1});a.onReady(l=>{c(l),document.dispatchEvent(new CustomEvent(w.READY,{detail:l}))}),a.onShow(l=>{c(l),document.dispatchEvent(new CustomEvent(w.SHOW,{detail:l}))}),a.onChange(l=>{c(l),document.dispatchEvent(new CustomEvent(w.CHANGE,{detail:l}))}),a.onTargetAction(l=>{c(l.context),document.dispatchEvent(new CustomEvent(w.TARGET_ACTION,{detail:l}))}),a.onElementEvent((l,f,d)=>{document.dispatchEvent(new CustomEvent(w.TARGET_ELEMENT_EVENT,{detail:{id:l,type:f,payload:d}}))}),a.onAdminSettingsChange(l=>{c({type:"admin_settings",settings:l}),document.dispatchEvent(new CustomEvent(w.ADMIN_SETTINGS_CHANGE,{detail:l}))}),a.run().then(()=>i(a))},[]),t&&console.debug(n?"Deskpro apps client is ready":"Deskpro apps client is initialising...");const u=e??j;return N.jsxs(B,{theme:u,children:[N.jsx($,{}),N.jsx(de.Provider,{value:{client:n,context:o,registeredElements:h,setRegisteredElements:g,theme:u},children:s})]})};try{F.displayName="DeskproAppProvider",F.__docgenInfo={description:"",displayName:"DeskproAppProvider",props:{theme:{defaultValue:null,description:"",name:"theme",required:!1,type:{name:"DeskproTheme"}},debug:{defaultValue:null,description:"",name:"debug",required:!1,type:{name:"boolean"}}}}}catch{}export{F as D,de as a};
