var $=Object.defineProperty;var L=(s,e,t)=>e in s?$(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var o=(s,e,t)=>(L(s,typeof e!="symbol"?e+"":e,t),t);import{j as M,a as V}from"./jsx-runtime-29545a09.js";import{r as _}from"./index-76fb7be0.js";import{a5 as B,a6 as F,l as j}from"./SPA-7e65fab1.js";import"./index-d3ea75b5.js";const W=s=>_.createElement(B.Provider,{value:s.theme},s.children);var v=(s=>(s.READY="ready.app.deskpro",s.SHOW="show.app.deskpro",s.CHANGE="change.app.deskpro",s.TARGET_ACTION="target_action.app.deskpro",s.TARGET_ELEMENT_EVENT="target_element_event.app.deskpro",s.ADMIN_SETTINGS_CHANGE="change.settings.admin.app.deskpro",s))(v||{}),A;(function(s){s.Call="call",s.Reply="reply",s.Syn="syn",s.SynAck="synAck",s.Ack="ack"})(A||(A={}));var k;(function(s){s.Fulfilled="fulfilled",s.Rejected="rejected"})(k||(k={}));var I;(function(s){s.ConnectionDestroyed="ConnectionDestroyed",s.ConnectionTimeout="ConnectionTimeout",s.NoIframeSrc="NoIframeSrc"})(I||(I={}));var O;(function(s){s.DataCloneError="DataCloneError"})(O||(O={}));var E;(function(s){s.Message="message"})(E||(E={}));const J=(s,e)=>{const t=[];let i=!1;return{destroy(n){i||(i=!0,e(`${s}: Destroying connection`),t.forEach(r=>{r(n)}))},onDestroy(n){i?n():t.push(n)}}},K=s=>(...e)=>{s&&console.log("[Penpal]",...e)},D=({name:s,message:e,stack:t})=>({name:s,message:e,stack:t}),Y=s=>{const e=new Error;return Object.keys(s).forEach(t=>e[t]=s[t]),e},q=(s,e,t)=>{const{localName:i,local:n,remote:r,originForSending:a,originForReceiving:d}=s;let u=!1;const h=l=>{if(l.source!==r||l.data.penpal!==A.Call)return;if(d!=="*"&&l.origin!==d){t(`${i} received message from origin ${l.origin} which did not match expected origin ${d}`);return}const c=l.data,{methodName:g,args:m,id:p}=c;t(`${i}: Received ${g}() call`);const C=y=>f=>{if(t(`${i}: Sending ${g}() reply`),u){t(`${i}: Unable to send ${g}() reply due to destroyed connection`);return}const S={penpal:A.Reply,id:p,resolution:y,returnValue:f};y===k.Rejected&&f instanceof Error&&(S.returnValue=D(f),S.returnValueIsError=!0);try{r.postMessage(S,a)}catch(T){if(T.name===O.DataCloneError){const P={penpal:A.Reply,id:p,resolution:k.Rejected,returnValue:D(T),returnValueIsError:!0};r.postMessage(P,a)}throw T}};new Promise(y=>y(e[g].apply(e,m))).then(C(k.Fulfilled),C(k.Rejected))};return n.addEventListener(E.Message,h),()=>{u=!0,n.removeEventListener(E.Message,h)}};let Q=0;const X=()=>++Q,x=".",G=s=>s?s.split(x):[],Z=s=>s.join(x),ee=(s,e)=>{const t=G(e||"");return t.push(s),Z(t)},te=(s,e,t)=>{const i=G(e);return i.reduce((n,r,a)=>(typeof n[r]>"u"&&(n[r]={}),a===i.length-1&&(n[r]=t),n[r]),s),s},H=(s,e)=>{const t={};return Object.keys(s).forEach(i=>{const n=s[i],r=ee(i,e);typeof n=="object"&&Object.assign(t,H(n,r)),typeof n=="function"&&(t[r]=n)}),t},se=s=>{const e={};for(const t in s)te(e,t,s[t]);return e},ne=(s,e,t,i,n)=>{const{localName:r,local:a,remote:d,originForSending:u,originForReceiving:h}=e;let l=!1;n(`${r}: Connecting call sender`);const c=m=>(...p)=>{n(`${r}: Sending ${m}() call`);let C;try{d.closed&&(C=!0)}catch{C=!0}if(C&&i(),l){const y=new Error(`Unable to send ${m}() call due to destroyed connection`);throw y.code=I.ConnectionDestroyed,y}return new Promise((y,f)=>{const S=X(),T=w=>{if(w.source!==d||w.data.penpal!==A.Reply||w.data.id!==S)return;if(h!=="*"&&w.origin!==h){n(`${r} received message from origin ${w.origin} which did not match expected origin ${h}`);return}const b=w.data;n(`${r}: Received ${m}() reply`),a.removeEventListener(E.Message,T);let U=b.returnValue;b.returnValueIsError&&(U=Y(U)),(b.resolution===k.Fulfilled?y:f)(U)};a.addEventListener(E.Message,T);const P={penpal:A.Call,id:S,methodName:m,args:p};d.postMessage(P,u)})},g=t.reduce((m,p)=>(m[p]=c(p),m),{});return Object.assign(s,se(g)),()=>{l=!0}},ie=(s,e)=>{let t;return s!==void 0&&(t=window.setTimeout(()=>{const i=new Error(`Connection timed out after ${s}ms`);i.code=I.ConnectionTimeout,e(i)},s)),()=>{clearTimeout(t)}},re=(s,e,t,i)=>{const{destroy:n,onDestroy:r}=t;return a=>{if(!(s instanceof RegExp?s.test(a.origin):s==="*"||s===a.origin)){i(`Child: Handshake - Received SYN-ACK from origin ${a.origin} which did not match expected origin ${s}`);return}i("Child: Handshake - Received SYN-ACK, responding with ACK");const u=a.origin==="null"?"*":a.origin,h={penpal:A.Ack,methodNames:Object.keys(e)};window.parent.postMessage(h,u);const l={localName:"Child",local:window,remote:window.parent,originForSending:u,originForReceiving:a.origin},c=q(l,e,i);r(c);const g={},m=ne(g,l,a.data.methodNames,n,i);return r(m),g}},ae=()=>{try{clearTimeout()}catch{return!1}return!0},oe=(s={})=>{const{parentOrigin:e="*",methods:t={},timeout:i,debug:n=!1}=s,r=K(n),a=J("Child",r),{destroy:d,onDestroy:u}=a,h=H(t),l=re(e,h,a,r),c=()=>{r("Child: Handshake - Sending SYN");const m={penpal:A.Syn},p=e instanceof RegExp?"*":e;window.parent.postMessage(m,p)};return{promise:new Promise((m,p)=>{const C=ie(i,d),y=f=>{if(ae()&&!(f.source!==parent||!f.data)&&f.data.penpal===A.SynAck){const S=l(f);S&&(window.removeEventListener(E.Message,y),C(),m(S))}};window.addEventListener(E.Message,y),c(),u(f=>{window.removeEventListener(E.Message,y),f&&p(f)})}),destroy(){d()}}};class ce{constructor(e){this.client=e}send(e){return this.client.sendDeskproUIMessage(e)}appendContentToActiveTicketReplyBox(e){return this.send({type:"append_to_active_ticket_reply_box",content:e})}appendLinkToActiveTicketReplyBox(e,t,i){return this.send({type:"append_link_to_active_ticket_reply_box",url:e,text:t,title:i})}}class le{constructor(e,t,i){this.client=e,this.name=t,this.entityId=i}async get(e){const t=await this.client.entityAssociationGet(this.entityId,this.name,e);return t?JSON.parse(t):null}list(){return this.client.entityAssociationList(this.entityId,this.name)}set(e,t){return this.client.entityAssociationSet(this.entityId,this.name,e,t?JSON.stringify(t):void 0)}delete(e){return this.client.entityAssociationDelete(this.entityId,this.name,e)}}class de{constructor(e){this.client=e}async getCallbackUrl(e,t,i){const n=(i==null?void 0:i.timeout)??3e5,r=(i==null?void 0:i.pollInterval)??1e3,a=await this.client.getOAuth2CallbackUrl(e,t.source,n,i==null?void 0:i.expires);return{poll:()=>new Promise((u,h)=>{const l=setInterval(()=>{this.client.hasUserState(a.statePath).then(c=>{c&&(clearInterval(l),u({statePath:a.statePath,statePathPlaceholder:a.statePathPlaceholder}))})},r);setTimeout(()=>{clearInterval(l),h("Token acquisition timeout")},n)}),callbackUrl:a.url}}async getGenericCallbackUrl(e,t,i,n){const r=(n==null?void 0:n.timeout)??3e5,a=(n==null?void 0:n.pollInterval)??1e3,d=await this.client.getStaticOAuth2CallbackUrl(e,t.source,i.source,r,n==null?void 0:n.expires);return{poll:()=>new Promise((h,l)=>{const c=setInterval(()=>{this.client.getStaticOAuth2Token(e).then(g=>{g&&(clearInterval(c),h({token:g}))})},a);setTimeout(()=>{clearInterval(c),l("Token acquisition timeout")},r)}),callbackUrl:d.url}}async getAdminGenericCallbackUrl(e,t,i,n){const r=(n==null?void 0:n.timeout)??3e5,a=(n==null?void 0:n.pollInterval)??1e3,d=await this.client.getStaticOAuth2CallbackUrl(e,t.source,i.source,r,n==null?void 0:n.expires);return{poll:()=>new Promise((h,l)=>{const c=setInterval(()=>{this.client.getStaticOAuth2Token(e).then(g=>{g&&(clearInterval(c),h({token:g}))})},a);setTimeout(()=>{clearInterval(c),l("Token acquisition timeout")},r)}),callbackUrl:d.url}}}class he{constructor(e,t){o(this,"parentMethods",{onReady:()=>{},onShow:()=>{},onChange:()=>{},onTargetAction:()=>{},onElementEvent:()=>{},onAdminSettingsChange:()=>{}});o(this,"getProxyAuth");o(this,"getAdminGenericProxyAuth");o(this,"resize");o(this,"setHeight");o(this,"setWidth");o(this,"registerElement");o(this,"deregisterElement");o(this,"setBadgeCount");o(this,"setTitle");o(this,"entityAssociationSet");o(this,"entityAssociationDelete");o(this,"entityAssociationGet");o(this,"entityAssociationList");o(this,"entityAssociationCountEntities");o(this,"setState");o(this,"setUserState");o(this,"getState");o(this,"getUserState");o(this,"deleteState");o(this,"deleteUserState");o(this,"hasState");o(this,"hasUserState");o(this,"setSetting");o(this,"setSettings");o(this,"setBlocking");o(this,"registerTargetAction");o(this,"deregisterTargetAction");o(this,"getOAuth2CallbackUrl");o(this,"getStaticOAuth2CallbackUrl");o(this,"getStaticOAuth2CallbackUrlValue");o(this,"getStaticOAuth2Token");o(this,"setAdminSetting");o(this,"setAdminSettingInvalid");o(this,"sendDeskproUIMessage");this.parent=e,this.options=t,this.getProxyAuth=()=>new Promise(()=>{}),this.getAdminGenericProxyAuth=()=>new Promise(()=>{}),this.resize=()=>{},this.setWidth=()=>{},this.setHeight=()=>{},this.registerElement=()=>{},this.deregisterElement=()=>{},this.setBadgeCount=()=>{},this.setTitle=()=>{},this.entityAssociationSet=async()=>{},this.entityAssociationDelete=async()=>{},this.entityAssociationGet=async()=>null,this.entityAssociationList=async()=>[""],this.entityAssociationCountEntities=async()=>0,this.setState=async()=>({isSuccess:!1,errors:[]}),this.setUserState=async()=>({isSuccess:!1,errors:[]}),this.getState=async()=>[],this.getUserState=async()=>[],this.deleteState=async()=>!1,this.deleteUserState=async()=>!1,this.hasState=async()=>!1,this.hasUserState=async()=>!1,this.setSetting=async()=>{},this.setSettings=async()=>{},this.setBlocking=async()=>{},this.registerTargetAction=async()=>{},this.deregisterTargetAction=async()=>{},this.getOAuth2CallbackUrl=async()=>({url:"",statePath:"",statePathPlaceholder:""}),this.getStaticOAuth2CallbackUrl=async()=>({url:""}),this.getStaticOAuth2CallbackUrlValue=async()=>"",this.getStaticOAuth2Token=async()=>null,this.setAdminSetting=async()=>{},this.setAdminSettingInvalid=async()=>{},this.sendDeskproUIMessage=async()=>{},this.options.runAfterPageLoad&&window.addEventListener("load",()=>this.run())}async run(){const e=await this.parent({methods:{_onReady:this.parentMethods.onReady,_onShow:this.parentMethods.onShow,_onChange:this.parentMethods.onChange,_onTargetAction:this.parentMethods.onTargetAction,_onElementEvent:this.parentMethods.onElementEvent,_onAdminSettingsChange:this.parentMethods.onAdminSettingsChange}}).promise;e._getProxyAuth&&(this.getProxyAuth=e._getProxyAuth),e._getAdminGenericProxyAuth&&(this.getAdminGenericProxyAuth=e._getAdminGenericProxyAuth),document&&e._setHeight&&(this.resize=t=>e._setHeight(t??document.body.scrollHeight)),e._registerElement&&(this.registerElement=(t,i)=>e._registerElement(t,i)),e._deregisterElement&&(this.deregisterElement=t=>e._deregisterElement(t)),e._setWidth&&(this.setWidth=e._setWidth),e._setHeight&&(this.setHeight=e._setHeight),e.setBadgeCount&&(this.setBadgeCount=e.setBadgeCount),e.setTitle&&(this.setTitle=e.setTitle),e._entityAssociationGet&&(this.entityAssociationGet=e._entityAssociationGet),e._entityAssociationSet&&(this.entityAssociationSet=e._entityAssociationSet),e._entityAssociationList&&(this.entityAssociationList=e._entityAssociationList),e._entityAssociationDelete&&(this.entityAssociationDelete=e._entityAssociationDelete),e._entityAssociationCountEntities&&(this.entityAssociationCountEntities=e._entityAssociationCountEntities),e._stateSet&&(this.setState=(t,i,n)=>e._stateSet(t,JSON.stringify(i),n)),e._userStateSet&&(this.setUserState=(t,i,n)=>e._userStateSet(t,JSON.stringify(i),n)),e._stateGet&&(this.getState=async t=>(JSON.parse(await e._stateGet(t))??[]).map(n=>({...n,data:n.data?JSON.parse(n.data):null}))),e._userStateGet&&(this.getUserState=async t=>(JSON.parse(await e._userStateGet(t))??[]).map(n=>({...n,data:n.data?JSON.parse(n.data):null}))),e._stateDelete&&(this.deleteState=e._stateDelete),e._userStateDelete&&(this.deleteUserState=e._userStateDelete),e._stateHas&&(this.hasState=e._stateHas),e._userStateHas&&(this.hasUserState=e._userStateHas),e._settingSet&&(this.setSetting=(t,i)=>e._settingSet(t,i)),e._settingsSet&&(this.setSettings=t=>e._settingsSet(JSON.stringify(t))),e._blockingSet&&(this.setBlocking=t=>e._blockingSet(t)),e._registerTargetAction&&(this.registerTargetAction=(t,i,n)=>e._registerTargetAction(t,i,n)),e._deregisterTargetAction&&(this.deregisterTargetAction=t=>e._deregisterTargetAction(t)),e._getOAuth2CallbackUrl&&(this.getOAuth2CallbackUrl=(t,i,n,r)=>e._getOAuth2CallbackUrl(t,i,n,r)),e._getStaticOAuth2CallbackUrl&&(this.getStaticOAuth2CallbackUrl=(t,i,n,r,a)=>e._getStaticOAuth2CallbackUrl(t,i,n,r,a)),e._getStaticOAuth2CallbackUrlValue&&(this.getStaticOAuth2CallbackUrlValue=()=>e._getStaticOAuth2CallbackUrlValue()),e._getStaticOAuth2Token&&(this.getStaticOAuth2Token=t=>e._getStaticOAuth2Token(t)),e._setAdminSetting&&(this.setAdminSetting=t=>e._setAdminSetting(t)),e._setAdminSettingInvalid&&(this.setAdminSettingInvalid=(t,i)=>e._setAdminSettingInvalid(t,i)),e._sendDeskproUIMessage&&(this.sendDeskproUIMessage=t=>e._sendDeskproUIMessage(t))}onReady(e){this.parentMethods.onReady=t=>{e(t),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onShow(e){this.parentMethods.onShow=t=>{e(t),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onChange(e){this.parentMethods.onChange=t=>{e(t),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onTargetAction(e){this.parentMethods.onTargetAction=t=>{e(t),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onElementEvent(e){this.parentMethods.onElementEvent=(t,i,n)=>{e(t,i,n),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onAdminSettingsChange(e){this.parentMethods.onAdminSettingsChange=t=>{e(t)}}getEntityAssociation(e,t){return new le(this,e,t)}oauth2(){return new de(this)}deskpro(){return new ce(this)}getParentMethods(){return this.parentMethods}}const ue=(s={})=>new he(oe,s),z=_.createContext(null),ge=()=>{const s=_.useContext(z);return{client:(s==null?void 0:s.client)??null}},R=({children:s})=>{const{client:e}=ge(),t=_.useRef(null);return _.useEffect(()=>{if(!t.current)return;const i=document.body,n=window.getComputedStyle(i),r=n.getPropertyValue("margin-top"),a=n.getPropertyValue("margin-bottom"),d=parseInt(r)??0+parseInt(a)??0,u=new ResizeObserver(()=>{e==null||e.setHeight(document.body.scrollHeight+d)});return u.observe(t.current),()=>u.disconnect()},[e]),M("div",{ref:t,children:s})};try{R.displayName="HeightWrapper",R.__docgenInfo={description:"",displayName:"HeightWrapper",props:{}}}catch{}const N=({children:s,theme:e,debug:t})=>{const[i,n]=_.useState(null),[r,a]=_.useState(null),[d,u]=_.useState([]);_.useEffect(()=>{if(i)return;const l=ue({runAfterPageLoad:!1,resizeAfterEvents:!1});l.onReady(c=>{a(c),document.dispatchEvent(new CustomEvent(v.READY,{detail:c}))}),l.onShow(c=>{a(c),document.dispatchEvent(new CustomEvent(v.SHOW,{detail:c}))}),l.onChange(c=>{a(c),document.dispatchEvent(new CustomEvent(v.CHANGE,{detail:c}))}),l.onTargetAction(c=>{a(c.context),document.dispatchEvent(new CustomEvent(v.TARGET_ACTION,{detail:c}))}),l.onElementEvent((c,g,m)=>{document.dispatchEvent(new CustomEvent(v.TARGET_ELEMENT_EVENT,{detail:{id:c,type:g,payload:m}}))}),l.onAdminSettingsChange(c=>{a({type:"admin_settings",settings:c}),document.dispatchEvent(new CustomEvent(v.ADMIN_SETTINGS_CHANGE,{detail:c}))}),l.run().then(()=>n(l))},[]),t&&console.debug(i?"Deskpro apps client is ready":"Deskpro apps client is initialising...");const h=e??j;return V(W,{theme:h,children:[M(F,{}),M(z.Provider,{value:{client:i,context:r,registeredElements:d,setRegisteredElements:u,theme:h},children:M(R,{children:s})})]})};try{N.displayName="DeskproAppProvider",N.__docgenInfo={description:"",displayName:"DeskproAppProvider",props:{theme:{defaultValue:null,description:"",name:"theme",required:!1,type:{name:"DeskproTheme"}},debug:{defaultValue:null,description:"",name:"debug",required:!1,type:{name:"boolean"}}}}}catch{}export{N as D,z as a};
