var L=Object.defineProperty;var V=(s,e,t)=>e in s?L(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var o=(s,e,t)=>(V(s,typeof e!="symbol"?e+"":e,t),t);import{j as M,a as B}from"./jsx-runtime-29545a09.js";import{r as _}from"./index-76fb7be0.js";import{a5 as F,a6 as j,l as W}from"./SPA-7e65fab1.js";import"./index-d3ea75b5.js";const J=s=>_.createElement(F.Provider,{value:s.theme},s.children);var v=(s=>(s.READY="ready.app.deskpro",s.SHOW="show.app.deskpro",s.CHANGE="change.app.deskpro",s.TARGET_ACTION="target_action.app.deskpro",s.TARGET_ELEMENT_EVENT="target_element_event.app.deskpro",s.ADMIN_SETTINGS_CHANGE="change.settings.admin.app.deskpro",s))(v||{}),A;(function(s){s.Call="call",s.Reply="reply",s.Syn="syn",s.SynAck="synAck",s.Ack="ack"})(A||(A={}));var k;(function(s){s.Fulfilled="fulfilled",s.Rejected="rejected"})(k||(k={}));var I;(function(s){s.ConnectionDestroyed="ConnectionDestroyed",s.ConnectionTimeout="ConnectionTimeout",s.NoIframeSrc="NoIframeSrc"})(I||(I={}));var O;(function(s){s.DataCloneError="DataCloneError"})(O||(O={}));var E;(function(s){s.Message="message"})(E||(E={}));const K=(s,e)=>{const t=[];let n=!1;return{destroy(i){n||(n=!0,e(`${s}: Destroying connection`),t.forEach(r=>{r(i)}))},onDestroy(i){n?i():t.push(i)}}},Y=s=>(...e)=>{s&&console.log("[Penpal]",...e)},D=({name:s,message:e,stack:t})=>({name:s,message:e,stack:t}),q=s=>{const e=new Error;return Object.keys(s).forEach(t=>e[t]=s[t]),e},Q=(s,e,t)=>{const{localName:n,local:i,remote:r,originForSending:a,originForReceiving:d}=s;let m=!1;const h=l=>{if(l.source!==r||l.data.penpal!==A.Call)return;if(d!=="*"&&l.origin!==d){t(`${n} received message from origin ${l.origin} which did not match expected origin ${d}`);return}const c=l.data,{methodName:u,args:g,id:p}=c;t(`${n}: Received ${u}() call`);const C=y=>f=>{if(t(`${n}: Sending ${u}() reply`),m){t(`${n}: Unable to send ${u}() reply due to destroyed connection`);return}const S={penpal:A.Reply,id:p,resolution:y,returnValue:f};y===k.Rejected&&f instanceof Error&&(S.returnValue=D(f),S.returnValueIsError=!0);try{r.postMessage(S,a)}catch(T){if(T.name===O.DataCloneError){const P={penpal:A.Reply,id:p,resolution:k.Rejected,returnValue:D(T),returnValueIsError:!0};r.postMessage(P,a)}throw T}};new Promise(y=>y(e[u].apply(e,g))).then(C(k.Fulfilled),C(k.Rejected))};return i.addEventListener(E.Message,h),()=>{m=!0,i.removeEventListener(E.Message,h)}};let X=0;const Z=()=>++X,G=".",H=s=>s?s.split(G):[],ee=s=>s.join(G),te=(s,e)=>{const t=H(e||"");return t.push(s),ee(t)},se=(s,e,t)=>{const n=H(e);return n.reduce((i,r,a)=>(typeof i[r]>"u"&&(i[r]={}),a===n.length-1&&(i[r]=t),i[r]),s),s},z=(s,e)=>{const t={};return Object.keys(s).forEach(n=>{const i=s[n],r=te(n,e);typeof i=="object"&&Object.assign(t,z(i,r)),typeof i=="function"&&(t[r]=i)}),t},ne=s=>{const e={};for(const t in s)se(e,t,s[t]);return e},ie=(s,e,t,n,i)=>{const{localName:r,local:a,remote:d,originForSending:m,originForReceiving:h}=e;let l=!1;i(`${r}: Connecting call sender`);const c=g=>(...p)=>{i(`${r}: Sending ${g}() call`);let C;try{d.closed&&(C=!0)}catch{C=!0}if(C&&n(),l){const y=new Error(`Unable to send ${g}() call due to destroyed connection`);throw y.code=I.ConnectionDestroyed,y}return new Promise((y,f)=>{const S=Z(),T=w=>{if(w.source!==d||w.data.penpal!==A.Reply||w.data.id!==S)return;if(h!=="*"&&w.origin!==h){i(`${r} received message from origin ${w.origin} which did not match expected origin ${h}`);return}const b=w.data;i(`${r}: Received ${g}() reply`),a.removeEventListener(E.Message,T);let U=b.returnValue;b.returnValueIsError&&(U=q(U)),(b.resolution===k.Fulfilled?y:f)(U)};a.addEventListener(E.Message,T);const P={penpal:A.Call,id:S,methodName:g,args:p};d.postMessage(P,m)})},u=t.reduce((g,p)=>(g[p]=c(p),g),{});return Object.assign(s,ne(u)),()=>{l=!0}},re=(s,e)=>{let t;return s!==void 0&&(t=window.setTimeout(()=>{const n=new Error(`Connection timed out after ${s}ms`);n.code=I.ConnectionTimeout,e(n)},s)),()=>{clearTimeout(t)}},ae=(s,e,t,n)=>{const{destroy:i,onDestroy:r}=t;return a=>{if(!(s instanceof RegExp?s.test(a.origin):s==="*"||s===a.origin)){n(`Child: Handshake - Received SYN-ACK from origin ${a.origin} which did not match expected origin ${s}`);return}n("Child: Handshake - Received SYN-ACK, responding with ACK");const m=a.origin==="null"?"*":a.origin,h={penpal:A.Ack,methodNames:Object.keys(e)};window.parent.postMessage(h,m);const l={localName:"Child",local:window,remote:window.parent,originForSending:m,originForReceiving:a.origin},c=Q(l,e,n);r(c);const u={},g=ie(u,l,a.data.methodNames,i,n);return r(g),u}},oe=()=>{try{clearTimeout()}catch{return!1}return!0},ce=(s={})=>{const{parentOrigin:e="*",methods:t={},timeout:n,debug:i=!1}=s,r=Y(i),a=K("Child",r),{destroy:d,onDestroy:m}=a,h=z(t),l=ae(e,h,a,r),c=()=>{r("Child: Handshake - Sending SYN");const g={penpal:A.Syn},p=e instanceof RegExp?"*":e;window.parent.postMessage(g,p)};return{promise:new Promise((g,p)=>{const C=re(n,d),y=f=>{if(oe()&&!(f.source!==parent||!f.data)&&f.data.penpal===A.SynAck){const S=l(f);S&&(window.removeEventListener(E.Message,y),C(),g(S))}};window.addEventListener(E.Message,y),c(),m(f=>{window.removeEventListener(E.Message,y),f&&p(f)})}),destroy(){d()}}};class le{constructor(e){this.client=e}send(e){return this.client.sendDeskproUIMessage(e)}appendContentToActiveTicketReplyBox(e){return this.send({type:"append_to_active_ticket_reply_box",content:e})}appendLinkToActiveTicketReplyBox(e,t,n){return this.send({type:"append_link_to_active_ticket_reply_box",url:e,text:t,title:n})}}class de{constructor(e,t,n){this.client=e,this.name=t,this.entityId=n}async get(e){const t=await this.client.entityAssociationGet(this.entityId,this.name,e);return t?JSON.parse(t):null}list(){return this.client.entityAssociationList(this.entityId,this.name)}set(e,t){return this.client.entityAssociationSet(this.entityId,this.name,e,t?JSON.stringify(t):void 0)}delete(e){return this.client.entityAssociationDelete(this.entityId,this.name,e)}}class he{constructor(e){this.client=e}async getCallbackUrl(e,t,n){const i=(n==null?void 0:n.timeout)??3e5,r=(n==null?void 0:n.pollInterval)??1e3,a=await this.client.getOAuth2CallbackUrl(e,t.source,i,n==null?void 0:n.expires);return{poll:()=>new Promise((m,h)=>{const l=setInterval(()=>{this.client.hasUserState(a.statePath).then(c=>{c&&(clearInterval(l),m({statePath:a.statePath,statePathPlaceholder:a.statePathPlaceholder}))})},r);setTimeout(()=>{clearInterval(l),h("Token acquisition timeout")},i)}),callbackUrl:a.url}}async getGenericCallbackUrl(e,t,n,i){const r=(i==null?void 0:i.timeout)??3e5,a=(i==null?void 0:i.pollInterval)??1e3,d=await this.client.getStaticOAuth2CallbackUrl(e,t.source,n.source,r,i==null?void 0:i.expires);return{poll:()=>new Promise((h,l)=>{const c=setInterval(()=>{this.client.getStaticOAuth2Token(e).then(u=>{u&&(clearInterval(c),h({token:u}))})},a);setTimeout(()=>{clearInterval(c),l("Token acquisition timeout")},r)}),callbackUrl:d.url}}async getAdminGenericCallbackUrl(e,t,n,i){const r=(i==null?void 0:i.timeout)??3e5,a=(i==null?void 0:i.pollInterval)??1e3,d=await this.client.getStaticOAuth2CallbackUrl(e,t.source,n.source,r,i==null?void 0:i.expires);return{poll:()=>new Promise((h,l)=>{const c=setInterval(()=>{this.client.getStaticOAuth2Token(e).then(u=>{u&&(clearInterval(c),h({token:u}))})},a);setTimeout(()=>{clearInterval(c),l("Token acquisition timeout")},r)}),callbackUrl:d.url}}}class ue{constructor(e,t){o(this,"parentMethods",{onReady:()=>{},onShow:()=>{},onChange:()=>{},onTargetAction:()=>{},onElementEvent:()=>{},onAdminSettingsChange:()=>{}});o(this,"getProxyAuth");o(this,"getAdminGenericProxyAuth");o(this,"resize");o(this,"setHeight");o(this,"setWidth");o(this,"registerElement");o(this,"deregisterElement");o(this,"setBadgeCount");o(this,"setTitle");o(this,"entityAssociationSet");o(this,"entityAssociationDelete");o(this,"entityAssociationGet");o(this,"entityAssociationList");o(this,"entityAssociationCountEntities");o(this,"setState");o(this,"setUserState");o(this,"getState");o(this,"getUserState");o(this,"deleteState");o(this,"deleteUserState");o(this,"hasState");o(this,"hasUserState");o(this,"setSetting");o(this,"setSettings");o(this,"setBlocking");o(this,"registerTargetAction");o(this,"deregisterTargetAction");o(this,"getOAuth2CallbackUrl");o(this,"getStaticOAuth2CallbackUrl");o(this,"getStaticOAuth2CallbackUrlValue");o(this,"getStaticOAuth2Token");o(this,"setAdminSetting");o(this,"setAdminSettingInvalid");o(this,"sendDeskproUIMessage");this.parent=e,this.options=t,this.getProxyAuth=()=>new Promise(()=>{}),this.getAdminGenericProxyAuth=()=>new Promise(()=>{}),this.resize=()=>{},this.setWidth=()=>{},this.setHeight=()=>{},this.registerElement=()=>{},this.deregisterElement=()=>{},this.setBadgeCount=()=>{},this.setTitle=()=>{},this.entityAssociationSet=async()=>{},this.entityAssociationDelete=async()=>{},this.entityAssociationGet=async()=>null,this.entityAssociationList=async()=>[""],this.entityAssociationCountEntities=async()=>0,this.setState=async()=>({isSuccess:!1,errors:[]}),this.setUserState=async()=>({isSuccess:!1,errors:[]}),this.getState=async()=>[],this.getUserState=async()=>[],this.deleteState=async()=>!1,this.deleteUserState=async()=>!1,this.hasState=async()=>!1,this.hasUserState=async()=>!1,this.setSetting=async()=>{},this.setSettings=async()=>{},this.setBlocking=async()=>{},this.registerTargetAction=async()=>{},this.deregisterTargetAction=async()=>{},this.getOAuth2CallbackUrl=async()=>({url:"",statePath:"",statePathPlaceholder:""}),this.getStaticOAuth2CallbackUrl=async()=>({url:""}),this.getStaticOAuth2CallbackUrlValue=async()=>"",this.getStaticOAuth2Token=async()=>null,this.setAdminSetting=async()=>{},this.setAdminSettingInvalid=async()=>{},this.sendDeskproUIMessage=async()=>{},this.options.runAfterPageLoad&&window.addEventListener("load",()=>this.run())}async run(){const e=await this.parent({methods:{_onReady:this.parentMethods.onReady,_onShow:this.parentMethods.onShow,_onChange:this.parentMethods.onChange,_onTargetAction:this.parentMethods.onTargetAction,_onElementEvent:this.parentMethods.onElementEvent,_onAdminSettingsChange:this.parentMethods.onAdminSettingsChange}}).promise;e._getProxyAuth&&(this.getProxyAuth=e._getProxyAuth),e._getAdminGenericProxyAuth&&(this.getAdminGenericProxyAuth=e._getAdminGenericProxyAuth),document&&e._setHeight&&(this.resize=t=>e._setHeight(t??document.body.scrollHeight)),e._registerElement&&(this.registerElement=(t,n)=>e._registerElement(t,n)),e._deregisterElement&&(this.deregisterElement=t=>e._deregisterElement(t)),e._setWidth&&(this.setWidth=e._setWidth),e._setHeight&&(this.setHeight=e._setHeight),e.setBadgeCount&&(this.setBadgeCount=e.setBadgeCount),e.setTitle&&(this.setTitle=e.setTitle),e._entityAssociationGet&&(this.entityAssociationGet=e._entityAssociationGet),e._entityAssociationSet&&(this.entityAssociationSet=e._entityAssociationSet),e._entityAssociationList&&(this.entityAssociationList=e._entityAssociationList),e._entityAssociationDelete&&(this.entityAssociationDelete=e._entityAssociationDelete),e._entityAssociationCountEntities&&(this.entityAssociationCountEntities=e._entityAssociationCountEntities),e._stateSet&&(this.setState=(t,n,i)=>e._stateSet(t,JSON.stringify(n),i)),e._userStateSet&&(this.setUserState=(t,n,i)=>e._userStateSet(t,JSON.stringify(n),i)),e._stateGet&&(this.getState=async t=>(JSON.parse(await e._stateGet(t))??[]).map(i=>({...i,data:i.data?JSON.parse(i.data):null}))),e._userStateGet&&(this.getUserState=async t=>(JSON.parse(await e._userStateGet(t))??[]).map(i=>({...i,data:i.data?JSON.parse(i.data):null}))),e._stateDelete&&(this.deleteState=e._stateDelete),e._userStateDelete&&(this.deleteUserState=e._userStateDelete),e._stateHas&&(this.hasState=e._stateHas),e._userStateHas&&(this.hasUserState=e._userStateHas),e._settingSet&&(this.setSetting=(t,n)=>e._settingSet(t,n)),e._settingsSet&&(this.setSettings=t=>e._settingsSet(JSON.stringify(t))),e._blockingSet&&(this.setBlocking=t=>e._blockingSet(t)),e._registerTargetAction&&(this.registerTargetAction=(t,n,i)=>e._registerTargetAction(t,n,i)),e._deregisterTargetAction&&(this.deregisterTargetAction=t=>e._deregisterTargetAction(t)),e._getOAuth2CallbackUrl&&(this.getOAuth2CallbackUrl=(t,n,i,r)=>e._getOAuth2CallbackUrl(t,n,i,r)),e._getStaticOAuth2CallbackUrl&&(this.getStaticOAuth2CallbackUrl=(t,n,i,r,a)=>e._getStaticOAuth2CallbackUrl(t,n,i,r,a)),e._getStaticOAuth2CallbackUrlValue&&(this.getStaticOAuth2CallbackUrlValue=()=>e._getStaticOAuth2CallbackUrlValue()),e._getStaticOAuth2Token&&(this.getStaticOAuth2Token=t=>e._getStaticOAuth2Token(t)),e._setAdminSetting&&(this.setAdminSetting=t=>e._setAdminSetting(t)),e._setAdminSettingInvalid&&(this.setAdminSettingInvalid=(t,n)=>e._setAdminSettingInvalid(t,n)),e._sendDeskproUIMessage&&(this.sendDeskproUIMessage=t=>e._sendDeskproUIMessage(t))}onReady(e){this.parentMethods.onReady=t=>{e(t),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onShow(e){this.parentMethods.onShow=t=>{e(t),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onChange(e){this.parentMethods.onChange=t=>{e(t),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onTargetAction(e){this.parentMethods.onTargetAction=t=>{e(t),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onElementEvent(e){this.parentMethods.onElementEvent=(t,n,i)=>{e(t,n,i),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onAdminSettingsChange(e){this.parentMethods.onAdminSettingsChange=t=>{e(t)}}getEntityAssociation(e,t){return new de(this,e,t)}oauth2(){return new he(this)}deskpro(){return new le(this)}getParentMethods(){return this.parentMethods}}const ge=(s={})=>new ue(ce,s),$=_.createContext(null),me=()=>{const s=_.useContext($);return{client:(s==null?void 0:s.client)??null}},N=s=>{const e=s.getPropertyValue("margin-top"),t=s.getPropertyValue("margin-bottom");return(parseInt(e)??0)+(parseInt(t)??0)},R=({children:s})=>{const{client:e}=me(),t=_.useRef(null);return _.useEffect(()=>{const n=t==null?void 0:t.current;if(!n)return;const i=new ResizeObserver(()=>{const r=n==null?void 0:n.children[0];if(r){const a=window.getComputedStyle(r),d=window.getComputedStyle(document.body);e==null||e.setHeight(n.scrollHeight+N(a)+N(d))}});return i.observe(n),()=>i.disconnect()},[e]),M("div",{ref:t,children:s})};try{R.displayName="HeightWrapper",R.__docgenInfo={description:"",displayName:"HeightWrapper",props:{}}}catch{}const x=({children:s,theme:e,debug:t})=>{const[n,i]=_.useState(null),[r,a]=_.useState(null),[d,m]=_.useState([]);_.useEffect(()=>{if(n)return;const l=ge({runAfterPageLoad:!1,resizeAfterEvents:!1});l.onReady(c=>{a(c),document.dispatchEvent(new CustomEvent(v.READY,{detail:c}))}),l.onShow(c=>{a(c),document.dispatchEvent(new CustomEvent(v.SHOW,{detail:c}))}),l.onChange(c=>{a(c),document.dispatchEvent(new CustomEvent(v.CHANGE,{detail:c}))}),l.onTargetAction(c=>{a(c.context),document.dispatchEvent(new CustomEvent(v.TARGET_ACTION,{detail:c}))}),l.onElementEvent((c,u,g)=>{document.dispatchEvent(new CustomEvent(v.TARGET_ELEMENT_EVENT,{detail:{id:c,type:u,payload:g}}))}),l.onAdminSettingsChange(c=>{a({type:"admin_settings",settings:c}),document.dispatchEvent(new CustomEvent(v.ADMIN_SETTINGS_CHANGE,{detail:c}))}),l.run().then(()=>i(l))},[]),t&&console.debug(n?"Deskpro apps client is ready":"Deskpro apps client is initialising...");const h=e??W;return B(J,{theme:h,children:[M(j,{}),M($.Provider,{value:{client:n,context:r,registeredElements:d,setRegisteredElements:m,theme:h},children:M(R,{children:s})})]})};try{x.displayName="DeskproAppProvider",x.__docgenInfo={description:"",displayName:"DeskproAppProvider",props:{theme:{defaultValue:null,description:"",name:"theme",required:!1,type:{name:"DeskproTheme"}},debug:{defaultValue:null,description:"",name:"debug",required:!1,type:{name:"boolean"}}}}}catch{}export{x as D,$ as a};
