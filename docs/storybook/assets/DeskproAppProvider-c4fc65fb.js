var z=Object.defineProperty;var H=(s,e,t)=>e in s?z(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var a=(s,e,t)=>(H(s,typeof e!="symbol"?e+"":e,t),t);import{a as $,j as b}from"./jsx-runtime-29545a09.js";import{r as w}from"./index-76fb7be0.js";import{Q as L,U as V,E as F}from"./SPA-4e5a8262.js";import"./index-d3ea75b5.js";const j=s=>w.createElement(L.Provider,{value:s.theme},s.children);var C=(s=>(s.READY="ready.app.deskpro",s.SHOW="show.app.deskpro",s.CHANGE="change.app.deskpro",s.TARGET_ACTION="target_action.app.deskpro",s.TARGET_ELEMENT_EVENT="target_element_event.app.deskpro",s.ADMIN_SETTINGS_CHANGE="change.settings.admin.app.deskpro",s))(C||{}),S;(function(s){s.Call="call",s.Reply="reply",s.Syn="syn",s.SynAck="synAck",s.Ack="ack"})(S||(S={}));var k;(function(s){s.Fulfilled="fulfilled",s.Rejected="rejected"})(k||(k={}));var M;(function(s){s.ConnectionDestroyed="ConnectionDestroyed",s.ConnectionTimeout="ConnectionTimeout",s.NoIframeSrc="NoIframeSrc"})(M||(M={}));var O;(function(s){s.DataCloneError="DataCloneError"})(O||(O={}));var _;(function(s){s.Message="message"})(_||(_={}));const B=(s,e)=>{const t=[];let i=!1;return{destroy(n){i||(i=!0,e(`${s}: Destroying connection`),t.forEach(r=>{r(n)}))},onDestroy(n){i?n():t.push(n)}}},J=s=>(...e)=>{s&&console.log("[Penpal]",...e)},R=({name:s,message:e,stack:t})=>({name:s,message:e,stack:t}),K=s=>{const e=new Error;return Object.keys(s).forEach(t=>e[t]=s[t]),e},W=(s,e,t)=>{const{localName:i,local:n,remote:r,originForSending:o,originForReceiving:d}=s;let m=!1;const h=l=>{if(l.source!==r||l.data.penpal!==S.Call)return;if(d!=="*"&&l.origin!==d){t(`${i} received message from origin ${l.origin} which did not match expected origin ${d}`);return}const c=l.data,{methodName:u,args:g,id:f}=c;t(`${i}: Received ${u}() call`);const E=y=>A=>{if(t(`${i}: Sending ${u}() reply`),m){t(`${i}: Unable to send ${u}() reply due to destroyed connection`);return}const p={penpal:S.Reply,id:f,resolution:y,returnValue:A};y===k.Rejected&&A instanceof Error&&(p.returnValue=R(A),p.returnValueIsError=!0);try{r.postMessage(p,o)}catch(v){if(v.name===O.DataCloneError){const I={penpal:S.Reply,id:f,resolution:k.Rejected,returnValue:R(v),returnValueIsError:!0};r.postMessage(I,o)}throw v}};new Promise(y=>y(e[u].apply(e,g))).then(E(k.Fulfilled),E(k.Rejected))};return n.addEventListener(_.Message,h),()=>{m=!0,n.removeEventListener(_.Message,h)}};let Y=0;const q=()=>++Y,N=".",x=s=>s?s.split(N):[],Q=s=>s.join(N),X=(s,e)=>{const t=x(e||"");return t.push(s),Q(t)},Z=(s,e,t)=>{const i=x(e);return i.reduce((n,r,o)=>(typeof n[r]>"u"&&(n[r]={}),o===i.length-1&&(n[r]=t),n[r]),s),s},G=(s,e)=>{const t={};return Object.keys(s).forEach(i=>{const n=s[i],r=X(i,e);typeof n=="object"&&Object.assign(t,G(n,r)),typeof n=="function"&&(t[r]=n)}),t},ee=s=>{const e={};for(const t in s)Z(e,t,s[t]);return e},te=(s,e,t,i,n)=>{const{localName:r,local:o,remote:d,originForSending:m,originForReceiving:h}=e;let l=!1;n(`${r}: Connecting call sender`);const c=g=>(...f)=>{n(`${r}: Sending ${g}() call`);let E;try{d.closed&&(E=!0)}catch{E=!0}if(E&&i(),l){const y=new Error(`Unable to send ${g}() call due to destroyed connection`);throw y.code=M.ConnectionDestroyed,y}return new Promise((y,A)=>{const p=q(),v=T=>{if(T.source!==d||T.data.penpal!==S.Reply||T.data.id!==p)return;if(h!=="*"&&T.origin!==h){n(`${r} received message from origin ${T.origin} which did not match expected origin ${h}`);return}const P=T.data;n(`${r}: Received ${g}() reply`),o.removeEventListener(_.Message,v);let U=P.returnValue;P.returnValueIsError&&(U=K(U)),(P.resolution===k.Fulfilled?y:A)(U)};o.addEventListener(_.Message,v);const I={penpal:S.Call,id:p,methodName:g,args:f};d.postMessage(I,m)})},u=t.reduce((g,f)=>(g[f]=c(f),g),{});return Object.assign(s,ee(u)),()=>{l=!0}},se=(s,e)=>{let t;return s!==void 0&&(t=window.setTimeout(()=>{const i=new Error(`Connection timed out after ${s}ms`);i.code=M.ConnectionTimeout,e(i)},s)),()=>{clearTimeout(t)}},ne=(s,e,t,i)=>{const{destroy:n,onDestroy:r}=t;return o=>{if(!(s instanceof RegExp?s.test(o.origin):s==="*"||s===o.origin)){i(`Child: Handshake - Received SYN-ACK from origin ${o.origin} which did not match expected origin ${s}`);return}i("Child: Handshake - Received SYN-ACK, responding with ACK");const m=o.origin==="null"?"*":o.origin,h={penpal:S.Ack,methodNames:Object.keys(e)};window.parent.postMessage(h,m);const l={localName:"Child",local:window,remote:window.parent,originForSending:m,originForReceiving:o.origin},c=W(l,e,i);r(c);const u={},g=te(u,l,o.data.methodNames,n,i);return r(g),u}},ie=()=>{try{clearTimeout()}catch{return!1}return!0},re=(s={})=>{const{parentOrigin:e="*",methods:t={},timeout:i,debug:n=!1}=s,r=J(n),o=B("Child",r),{destroy:d,onDestroy:m}=o,h=G(t),l=ne(e,h,o,r),c=()=>{r("Child: Handshake - Sending SYN");const g={penpal:S.Syn},f=e instanceof RegExp?"*":e;window.parent.postMessage(g,f)};return{promise:new Promise((g,f)=>{const E=se(i,d),y=A=>{if(ie()&&!(A.source!==parent||!A.data)&&A.data.penpal===S.SynAck){const p=l(A);p&&(window.removeEventListener(_.Message,y),E(),g(p))}};window.addEventListener(_.Message,y),c(),m(A=>{window.removeEventListener(_.Message,y),A&&f(A)})}),destroy(){d()}}};class ae{constructor(e){this.client=e}send(e){return this.client.sendDeskproUIMessage(e)}appendContentToActiveTicketReplyBox(e){return this.send({type:"append_to_active_ticket_reply_box",content:e})}appendLinkToActiveTicketReplyBox(e,t,i){return this.send({type:"append_link_to_active_ticket_reply_box",url:e,text:t,title:i})}}class oe{constructor(e,t,i){this.client=e,this.name=t,this.entityId=i}async get(e){const t=await this.client.entityAssociationGet(this.entityId,this.name,e);return t?JSON.parse(t):null}list(){return this.client.entityAssociationList(this.entityId,this.name)}set(e,t){return this.client.entityAssociationSet(this.entityId,this.name,e,t?JSON.stringify(t):void 0)}delete(e){return this.client.entityAssociationDelete(this.entityId,this.name,e)}}class ce{constructor(e){this.client=e}async getCallbackUrl(e,t,i){const n=(i==null?void 0:i.timeout)??3e5,r=(i==null?void 0:i.pollInterval)??1e3,o=await this.client.getOAuth2CallbackUrl(e,t.source,n,i==null?void 0:i.expires);return{poll:()=>new Promise((m,h)=>{const l=setInterval(()=>{this.client.hasUserState(o.statePath).then(c=>{c&&(clearInterval(l),m({statePath:o.statePath,statePathPlaceholder:o.statePathPlaceholder}))})},r);setTimeout(()=>{clearInterval(l),h("Token acquisition timeout")},n)}),callbackUrl:o.url}}async getGenericCallbackUrl(e,t,i,n){const r=(n==null?void 0:n.timeout)??3e5,o=(n==null?void 0:n.pollInterval)??1e3,d=await this.client.getStaticOAuth2CallbackUrl(e,t.source,i.source,r,n==null?void 0:n.expires);return{poll:()=>new Promise((h,l)=>{const c=setInterval(()=>{this.client.getStaticOAuth2Token(e).then(u=>{u&&(clearInterval(c),h({token:u}))})},o);setTimeout(()=>{clearInterval(c),l("Token acquisition timeout")},r)}),callbackUrl:d.url}}async getAdminGenericCallbackUrl(e,t,i,n){const r=(n==null?void 0:n.timeout)??3e5,o=(n==null?void 0:n.pollInterval)??1e3,d=await this.client.getStaticOAuth2CallbackUrl(e,t.source,i.source,r,n==null?void 0:n.expires);return{poll:()=>new Promise((h,l)=>{const c=setInterval(()=>{this.client.getStaticOAuth2Token(e).then(u=>{u&&(clearInterval(c),h({token:u}))})},o);setTimeout(()=>{clearInterval(c),l("Token acquisition timeout")},r)}),callbackUrl:d.url}}}class le{constructor(e,t){a(this,"parentMethods",{onReady:()=>{},onShow:()=>{},onChange:()=>{},onTargetAction:()=>{},onElementEvent:()=>{},onAdminSettingsChange:()=>{}});a(this,"getProxyAuth");a(this,"getAdminGenericProxyAuth");a(this,"resize");a(this,"setHeight");a(this,"setWidth");a(this,"registerElement");a(this,"deregisterElement");a(this,"setBadgeCount");a(this,"setTitle");a(this,"entityAssociationSet");a(this,"entityAssociationDelete");a(this,"entityAssociationGet");a(this,"entityAssociationList");a(this,"entityAssociationCountEntities");a(this,"setState");a(this,"setUserState");a(this,"getState");a(this,"getUserState");a(this,"deleteState");a(this,"deleteUserState");a(this,"hasState");a(this,"hasUserState");a(this,"setSetting");a(this,"setSettings");a(this,"setBlocking");a(this,"registerTargetAction");a(this,"deregisterTargetAction");a(this,"getOAuth2CallbackUrl");a(this,"getStaticOAuth2CallbackUrl");a(this,"getStaticOAuth2CallbackUrlValue");a(this,"getStaticOAuth2Token");a(this,"setAdminSetting");a(this,"setAdminSettingInvalid");a(this,"sendDeskproUIMessage");this.parent=e,this.options=t,this.getProxyAuth=()=>new Promise(()=>{}),this.getAdminGenericProxyAuth=()=>new Promise(()=>{}),this.resize=()=>{},this.setWidth=()=>{},this.setHeight=()=>{},this.registerElement=()=>{},this.deregisterElement=()=>{},this.setBadgeCount=()=>{},this.setTitle=()=>{},this.entityAssociationSet=async()=>{},this.entityAssociationDelete=async()=>{},this.entityAssociationGet=async()=>null,this.entityAssociationList=async()=>[""],this.entityAssociationCountEntities=async()=>0,this.setState=async()=>({isSuccess:!1,errors:[]}),this.setUserState=async()=>({isSuccess:!1,errors:[]}),this.getState=async()=>[],this.getUserState=async()=>[],this.deleteState=async()=>!1,this.deleteUserState=async()=>!1,this.hasState=async()=>!1,this.hasUserState=async()=>!1,this.setSetting=async()=>{},this.setSettings=async()=>{},this.setBlocking=async()=>{},this.registerTargetAction=async()=>{},this.deregisterTargetAction=async()=>{},this.getOAuth2CallbackUrl=async()=>({url:"",statePath:"",statePathPlaceholder:""}),this.getStaticOAuth2CallbackUrl=async()=>({url:""}),this.getStaticOAuth2CallbackUrlValue=async()=>"",this.getStaticOAuth2Token=async()=>null,this.setAdminSetting=async()=>{},this.setAdminSettingInvalid=async()=>{},this.sendDeskproUIMessage=async()=>{},this.options.runAfterPageLoad&&window.addEventListener("load",()=>this.run())}async run(){const e=await this.parent({methods:{_onReady:this.parentMethods.onReady,_onShow:this.parentMethods.onShow,_onChange:this.parentMethods.onChange,_onTargetAction:this.parentMethods.onTargetAction,_onElementEvent:this.parentMethods.onElementEvent,_onAdminSettingsChange:this.parentMethods.onAdminSettingsChange}}).promise;e._getProxyAuth&&(this.getProxyAuth=e._getProxyAuth),e._getAdminGenericProxyAuth&&(this.getAdminGenericProxyAuth=e._getAdminGenericProxyAuth),document&&e._setHeight&&(this.resize=t=>e._setHeight(t??document.body.scrollHeight)),e._registerElement&&(this.registerElement=(t,i)=>e._registerElement(t,i)),e._deregisterElement&&(this.deregisterElement=t=>e._deregisterElement(t)),e._setWidth&&(this.setWidth=e._setWidth),e._setHeight&&(this.setHeight=e._setHeight),e.setBadgeCount&&(this.setBadgeCount=e.setBadgeCount),e.setTitle&&(this.setTitle=e.setTitle),e._entityAssociationGet&&(this.entityAssociationGet=e._entityAssociationGet),e._entityAssociationSet&&(this.entityAssociationSet=e._entityAssociationSet),e._entityAssociationList&&(this.entityAssociationList=e._entityAssociationList),e._entityAssociationDelete&&(this.entityAssociationDelete=e._entityAssociationDelete),e._entityAssociationCountEntities&&(this.entityAssociationCountEntities=e._entityAssociationCountEntities),e._stateSet&&(this.setState=(t,i,n)=>e._stateSet(t,JSON.stringify(i),n)),e._userStateSet&&(this.setUserState=(t,i,n)=>e._userStateSet(t,JSON.stringify(i),n)),e._stateGet&&(this.getState=async t=>(JSON.parse(await e._stateGet(t))??[]).map(n=>({...n,data:n.data?JSON.parse(n.data):null}))),e._userStateGet&&(this.getUserState=async t=>(JSON.parse(await e._userStateGet(t))??[]).map(n=>({...n,data:n.data?JSON.parse(n.data):null}))),e._stateDelete&&(this.deleteState=e._stateDelete),e._userStateDelete&&(this.deleteUserState=e._userStateDelete),e._stateHas&&(this.hasState=e._stateHas),e._userStateHas&&(this.hasUserState=e._userStateHas),e._settingSet&&(this.setSetting=(t,i)=>e._settingSet(t,i)),e._settingsSet&&(this.setSettings=t=>e._settingsSet(JSON.stringify(t))),e._blockingSet&&(this.setBlocking=t=>e._blockingSet(t)),e._registerTargetAction&&(this.registerTargetAction=(t,i,n)=>e._registerTargetAction(t,i,n)),e._deregisterTargetAction&&(this.deregisterTargetAction=t=>e._deregisterTargetAction(t)),e._getOAuth2CallbackUrl&&(this.getOAuth2CallbackUrl=(t,i,n,r)=>e._getOAuth2CallbackUrl(t,i,n,r)),e._getStaticOAuth2CallbackUrl&&(this.getStaticOAuth2CallbackUrl=(t,i,n,r,o)=>e._getStaticOAuth2CallbackUrl(t,i,n,r,o)),e._getStaticOAuth2CallbackUrlValue&&(this.getStaticOAuth2CallbackUrlValue=()=>e._getStaticOAuth2CallbackUrlValue()),e._getStaticOAuth2Token&&(this.getStaticOAuth2Token=t=>e._getStaticOAuth2Token(t)),e._setAdminSetting&&(this.setAdminSetting=t=>e._setAdminSetting(t)),e._setAdminSettingInvalid&&(this.setAdminSettingInvalid=(t,i)=>e._setAdminSettingInvalid(t,i)),e._sendDeskproUIMessage&&(this.sendDeskproUIMessage=t=>e._sendDeskproUIMessage(t))}onReady(e){this.parentMethods.onReady=t=>{e(t),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onShow(e){this.parentMethods.onShow=t=>{e(t),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onChange(e){this.parentMethods.onChange=t=>{e(t),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onTargetAction(e){this.parentMethods.onTargetAction=t=>{e(t),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onElementEvent(e){this.parentMethods.onElementEvent=(t,i,n)=>{e(t,i,n),this.resize&&this.options.resizeAfterEvents&&this.resize()}}onAdminSettingsChange(e){this.parentMethods.onAdminSettingsChange=t=>{e(t)}}getEntityAssociation(e,t){return new oe(this,e,t)}oauth2(){return new ce(this)}deskpro(){return new ae(this)}getParentMethods(){return this.parentMethods}}const he=(s={})=>new le(re,s),de=w.createContext(null),D=({children:s,theme:e,debug:t})=>{const[i,n]=w.useState(null),[r,o]=w.useState(null),[d,m]=w.useState([]);w.useEffect(()=>{if(i)return;const l=he({runAfterPageLoad:!1,resizeAfterEvents:!1});l.onReady(c=>{o(c),document.dispatchEvent(new CustomEvent(C.READY,{detail:c}))}),l.onShow(c=>{o(c),document.dispatchEvent(new CustomEvent(C.SHOW,{detail:c}))}),l.onChange(c=>{o(c),document.dispatchEvent(new CustomEvent(C.CHANGE,{detail:c}))}),l.onTargetAction(c=>{o(c.context),document.dispatchEvent(new CustomEvent(C.TARGET_ACTION,{detail:c}))}),l.onElementEvent((c,u,g)=>{document.dispatchEvent(new CustomEvent(C.TARGET_ELEMENT_EVENT,{detail:{id:c,type:u,payload:g}}))}),l.onAdminSettingsChange(c=>{o({type:"admin_settings",settings:c}),document.dispatchEvent(new CustomEvent(C.ADMIN_SETTINGS_CHANGE,{detail:c}))}),l.run().then(()=>n(l))},[]),t&&console.debug(i?"Deskpro apps client is ready":"Deskpro apps client is initialising...");const h=e??F;return $(j,{theme:h,children:[b(V,{}),b(de.Provider,{value:{client:i,context:r,registeredElements:d,setRegisteredElements:m,theme:h},children:s})]})};try{D.displayName="DeskproAppProvider",D.__docgenInfo={description:"",displayName:"DeskproAppProvider",props:{theme:{defaultValue:null,description:"",name:"theme",required:!1,type:{name:"DeskproTheme"}},debug:{defaultValue:null,description:"",name:"debug",required:!1,type:{name:"boolean"}}}}}catch{}export{D,de as a};
//# sourceMappingURL=DeskproAppProvider-c4fc65fb.js.map
